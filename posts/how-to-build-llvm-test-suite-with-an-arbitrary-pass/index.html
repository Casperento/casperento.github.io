<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="How to build the LLVM Test Suite with an arbitrary pass?" /><meta property="og:locale" content="en" /><meta name="description" content="Recently, I embarked on my journey in compiler design by joining UFMG’s Compilers Lab as a graduate researcher." /><meta property="og:description" content="Recently, I embarked on my journey in compiler design by joining UFMG’s Compilers Lab as a graduate researcher." /><link rel="canonical" href="https://casperento.github.io/posts/how-to-build-llvm-test-suite-with-an-arbitrary-pass/" /><meta property="og:url" content="https://casperento.github.io/posts/how-to-build-llvm-test-suite-with-an-arbitrary-pass/" /><meta property="og:site_name" content="Casperento" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-05-15T21:00:00-03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="How to build the LLVM Test Suite with an arbitrary pass?" /><meta name="twitter:site" content="@Casperento" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-11-12T09:48:35-03:00","datePublished":"2024-05-15T21:00:00-03:00","description":"Recently, I embarked on my journey in compiler design by joining UFMG’s Compilers Lab as a graduate researcher.","headline":"How to build the LLVM Test Suite with an arbitrary pass?","mainEntityOfPage":{"@type":"WebPage","@id":"https://casperento.github.io/posts/how-to-build-llvm-test-suite-with-an-arbitrary-pass/"},"url":"https://casperento.github.io/posts/how-to-build-llvm-test-suite-with-an-arbitrary-pass/"}</script><title>How to build the LLVM Test Suite with an arbitrary pass? | Casperento</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Casperento"><meta name="application-name" content="Casperento"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/avatar/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Casperento</a></div><div class="site-subtitle font-italic">Personal blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/Casperento" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Casperento" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['cxpscripts','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>How to build the LLVM Test Suite with an arbitrary pass?</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>How to build the LLVM Test Suite with an arbitrary pass?</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1715817600" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 15, 2024 </em> </span> <span> Updated <em class="" data-ts="1731415715" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Nov 12, 2024 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/Casperento">Rafael Eckstein</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1552 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><p>Recently, I embarked on my journey in compiler design by joining <a href="https://lac-dcc.github.io/" target="_blank">UFMG’s Compilers Lab</a> as a graduate researcher.</p><p>My first challenge was to become familiar with LLVM and learn how to develop a pass for it. However, that’s not all, as we are also working with code compression techniques and require an infrastructure to test our developed passes. Fortunately, the <a href="https://github.com/llvm/llvm-test-suite" target="_blank">LLVM Test Suite</a> is available to us.</p><p>We are using LLVM 17 and its test suite. However, we discovered that compiling the entire project with a newly created pass is not a trivial task, since there are no intermediate steps in the CMake project for us to specify our new pass in the compilation pipeline. Therefore, we began researching new ways to compile the entire project with our new pass.</p><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Perhaps one of the nicest parts of the LLVM project is the Test Suite. This is a large collection of C and C++ benchmarks that compiler engineers can use to test the techniques that they implement. The suite includes a diverse array of programs and libraries, ranging from small, single-file programs to large, complex applications, ensuring comprehensive coverage of real-world scenarios.</p><p>By leveraging this extensive test suite, developers can assess the performance, correctness, and robustness of their compiler optimizations and transformations. Furthermore, the suite is continually updated and maintained by the LLVM community, incorporating new benchmarks and reflecting the latest industry practices. This makes it an invaluable resource for anyone involved in compiler development or research, providing a solid foundation for testing and validating new ideas in compiler technology.</p><h2 id="problem-statement"><span class="mr-2">Problem Statement</span><a href="#problem-statement" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Our task is to compile the entire Test Suite with an arbitrary pass, so that we can compare different metrics between a baseline and a chosen experiment. In other words, we want to enable the following pipeline:</p><ol><li>Compile every program in the Test Suite, producing a set of LLVM IR files. Let this collection of bytecodes be called “Control”;<li>Collect metrics from “Control”;<li>Compile every program in the Test Suite, this time with a set of passes of interest, producing a set of LLVM IR files. Let this new collection of bytecodes be called “Test”;<li>Collect metrics from “Test”;<li>Produce a report comparing metrics from “Control” and “Test”.</ol><p>As an example, assume that we want to test the <a href="https://github.com/rcorcs/llvm-project/commit/246386f55764c35901099ca03b6fda4e20d36354" target="_blank">func-merging</a> pass. This pass takes functions that are structurally equal and merge them to reduce code size. Imagine that we want to measure the code-size reduction enabled by this optimization. LLVM provides a pass to count instructions: <strong>instcount</strong>. Thus, we can combine these two passes to get the numbers that we want, e.g.:</p><ol><li>Produce the “Control” set of bytecode files;<li>Use the <strong>instcount</strong> pass to count the number of instructions in the “Control” dataset;<li>Produce the “Test” dataset applying <strong>func-merging</strong> onto the Control dataset;<li>Use the <strong>instcount</strong> pass to count the number of instructions in the “Test” dataset;<li>Produce a report comparing the number of instructions in the “Control” and “Test” datasets.</ol><h2 id="solution"><span class="mr-2">Solution</span><a href="#solution" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To solve our problem, we’re going to:</p><ol><li>Apply a patch in the Test Suite’s CMake project;<li>Run some shell commands to get the project compiled;<li>Run the test suite with LIT to get the results;<li>Finally, get the results compared.</ol><h3 id="cloning-llvm-test-suite"><span class="mr-2">Cloning LLVM Test Suite</span><a href="#cloning-llvm-test-suite" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>To clone the project’s repository, run the following command inside a folder of your choice:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>git clone <span class="nt">-b</span> release/17.x https://github.com/llvm/llvm-test-suite.git
</pre></table></code></div></div><h3 id="building-test-suite-binaries"><span class="mr-2">Building Test Suite Binaries</span><a href="#building-test-suite-binaries" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>To build the project, we need to apply our patch into the CMake files. Then, we’ll configure and build the entire Test Suite with our patch.</p><h4 id="applying-the-patch"><span class="mr-2">Applying the Patch</span><a href="#applying-the-patch" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The following commit synthesizes all changes we’ve made in our patch, for you to apply it locally:</p><p><a href="https://github.com/Casperento/llvm-test-suite/commit/967813878b1e69d0b7892c08ef227baa789d7083" target="_blank">Patch’s commit</a></p><h4 id="configuring-and-building-cmake-project"><span class="mr-2">Configuring and Building CMake Project</span><a href="#configuring-and-building-cmake-project" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>In our case, we want to count how many instructions programs have before applying our pass. Thus, we’re going to build the project two times, one to get the baseline tests’ results, and the second one to get our experiment tests’ result.</p><h5 id="first-running"><span class="mr-2">First Running</span><a href="#first-running" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>Assuming your current directory is <em>“path/to/llvm-test-suite”</em>, run:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> build
<span class="nv">$ </span><span class="nb">cd </span>build
<span class="nv">$ </span>cmake <span class="nt">-G</span> <span class="s2">"Ninja"</span> <span class="se">\</span>
<span class="nt">-DCMAKE_C_COMPILER</span><span class="o">=</span>clang <span class="se">\</span>
<span class="nt">-DCMAKE_CXX_COMPILER</span><span class="o">=</span>clang++ <span class="se">\</span>
<span class="nt">-DCMAKE_C_FLAGS</span><span class="o">=</span><span class="s2">"-flto"</span> <span class="se">\</span>
<span class="nt">-DCMAKE_CXX_FLAGS</span><span class="o">=</span><span class="s2">"-flto"</span> <span class="se">\</span>
<span class="nt">-DCMAKE_EXE_LINKER_FLAGS</span><span class="o">=</span><span class="s2">"-flto -fuse-ld=lld -Wl,--plugin-opt=-lto-embed-bitcode=post-merge-pre-opt"</span> <span class="se">\</span>
<span class="nt">-DTEST_SUITE_ARBITRARY_PASS</span><span class="o">=</span>ON <span class="se">\</span>
<span class="nt">-DTEST_SUITE_SELECTED_PASSES</span><span class="o">=</span> <span class="se">\</span>
<span class="nt">-DTEST_SUITE_PASSES_ARGS</span><span class="o">=</span> <span class="se">\</span>
<span class="s2">"-DTEST_SUITE_SUBDIRS=SingleSource;MultiSource"</span> <span class="se">\</span>
<span class="nt">-C</span> ../cmake/caches/O1.cmake ..
</pre></table></code></div></div><p><strong>Note</strong>: we assume you already have <strong>ninja-build</strong> installed. If you don’t, just ignore the <code class="language-plaintext highlighter-rouge">-G "Ninja"</code> argument in the CMake command.</p><p>Now, build the project with:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>cmake <span class="nt">--build</span> <span class="nb">.</span>
</pre></table></code></div></div><h5 id="running-lit"><span class="mr-2">Running LIT</span><a href="#running-lit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>To run the tests with LIT, create a separate folder for the results and run it:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-p</span> ~/lit-results
<span class="nv">$ </span>llvm-lit <span class="nt">-v</span> <span class="nt">-o</span> ~/lit-results/results_baseline.json <span class="nb">.</span>
</pre></table></code></div></div><h5 id="second-running"><span class="mr-2">Second Running</span><a href="#second-running" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>The chosen pass’ name must be specified by the <strong>TEST_SUITE_SELECTED_PASSES</strong> CMake env. variable. If you need to run a sequence of passes, just write them in the desired order separated by a comma, like:</p><blockquote><p>-DTEST_SUITE_SELECTED_PASSES=pass-1,pass-2</p></blockquote><p>It is also possible to pass arguments related to your pass using the following CMake env. variable:</p><blockquote><p>-DTEST_SUITE_PASSES_ARGS=-brfusion-soa=false\;-brfusion-threshold=0</p></blockquote><p><strong>Note</strong>: each option must be separated by the escaped semicolon character <code class="language-plaintext highlighter-rouge">\;</code>.</p><p>Then, to compile the test suite again with the chosen pass, reconfigure the CMake project with the following command:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nv">$ </span>cmake <span class="nt">-G</span> <span class="s2">"Ninja"</span> <span class="se">\</span>
<span class="nt">-DCMAKE_C_COMPILER</span><span class="o">=</span>clang <span class="se">\</span>
<span class="nt">-DCMAKE_CXX_COMPILER</span><span class="o">=</span>clang++ <span class="se">\</span>
<span class="nt">-DCMAKE_C_FLAGS</span><span class="o">=</span><span class="s2">"-flto"</span> <span class="se">\</span>
<span class="nt">-DCMAKE_CXX_FLAGS</span><span class="o">=</span><span class="s2">"-flto"</span> <span class="se">\</span>
<span class="nt">-DCMAKE_EXE_LINKER_FLAGS</span><span class="o">=</span><span class="s2">"-flto -fuse-ld=lld -Wl,--plugin-opt=-lto-embed-bitcode=post-merge-pre-opt"</span> <span class="se">\</span>
<span class="nt">-DTEST_SUITE_ARBITRARY_PASS</span><span class="o">=</span>ON <span class="se">\</span>
<span class="nt">-DTEST_SUITE_SELECTED_PASSES</span><span class="o">=</span>func-merging <span class="se">\</span>
<span class="nt">-DTEST_SUITE_PASSES_ARGS</span><span class="o">=</span> <span class="se">\</span>
<span class="s2">"-DTEST_SUITE_SUBDIRS=SingleSource;MultiSource"</span> <span class="se">\</span>
<span class="nt">-C</span> ../cmake/caches/O1.cmake ..
</pre></table></code></div></div><p>Then, build the project again:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>cmake <span class="nt">--build</span> <span class="nb">.</span>
</pre></table></code></div></div><h5 id="running-lit-1"><span class="mr-2">Running LIT</span><a href="#running-lit-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>Run the tests with LIT again:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>llvm-lit <span class="nt">-v</span> <span class="nt">-o</span> ~/lit-results/results_func-merging.json <span class="nb">.</span>
</pre></table></code></div></div><h5 id="comparing-results"><span class="mr-2">Comparing Results</span><a href="#comparing-results" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h5><p>To compare the results by <strong>instcount</strong> and <strong>size..text</strong> metrics, run the following python script provided by the test suite:</p><p>Assuming your current directory is <em>“path/to/llvm-test-suite/build”</em>.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>python3 ../utils/compare.py <span class="nt">--full</span> <span class="nt">--diff</span> <span class="nt">-m</span> instcount <span class="nt">-m</span> size..text ~/lit-results/results_baseline.json ~/lit-results/results_func-merging.json <span class="o">&gt;</span> ~/lit-results/test-results.txt
</pre></table></code></div></div><p><a href="https://gist.github.com/Casperento/debc184fb978231015e3e39765307040" target="_blank">Comparison Result</a></p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Our objective is to compile the Test Suite using different LLVM passes for metric comparison. Initially, we compile the suite with the <strong>instcount</strong> pass to determine the instruction count of generated bytecode files, establishing a baseline metric. Subsequently, we compile the same suite with the <strong>func-merging</strong> pass applied to the binaries and then reevaluate the instruction count.</p><p>By analyzing the differences in instruction counts between the baseline (using <strong>instcount</strong>) and the experimental setup (with <strong>func-merging</strong>), we can draw conclusions on the effectiveness of the <strong>func-merging</strong> pass for code compression within the LLVM framework.</p><hr /><h2 id="extra"><span class="mr-2">Extra</span><a href="#extra" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>There are some tweaks we can do when configuring the CMake project. For instance, we can select specific test suites to be compiled and run by LIT. Moreover, it is possible to skip targets that failed the CMake build process. Finally, it is possible to configure a shell script to automate the process of running and comparing experiments.</p><h3 id="build-specific-test-suites"><span class="mr-2">Build Specific Test Suites</span><a href="#build-specific-test-suites" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Let’s say we want to compile only the <em>SingleSource</em> and <em>MultiSource</em> test suites. To do that, we need to specify them using the following CMake variable:</p><blockquote><p>-DTEST_SUITE_SUBDIRS=semicolon;separated</p></blockquote><p>This way, we get the following CMake command to configure our baseline build:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nv">$ </span>cmake <span class="nt">-G</span> <span class="s2">"Ninja"</span> <span class="se">\</span>
<span class="nt">-DCMAKE_C_COMPILER</span><span class="o">=</span>clang <span class="se">\</span>
<span class="nt">-DCMAKE_CXX_COMPILER</span><span class="o">=</span>clang++ <span class="se">\</span>
<span class="nt">-DCMAKE_C_FLAGS</span><span class="o">=</span><span class="s2">"-flto"</span> <span class="se">\</span>
<span class="nt">-DCMAKE_CXX_FLAGS</span><span class="o">=</span><span class="s2">"-flto"</span> <span class="se">\</span>
<span class="nt">-DCMAKE_EXE_LINKER_FLAGS</span><span class="o">=</span><span class="s2">"-flto -fuse-ld=lld -Wl,--plugin-opt=-lto-embed-bitcode=post-merge-pre-opt"</span> <span class="se">\</span>
<span class="nt">-DTEST_SUITE_ARBITRARY_PASS</span><span class="o">=</span>ON <span class="se">\</span>
<span class="nt">-DTEST_SUITE_SELECTED_PASSES</span><span class="o">=</span> <span class="se">\</span>
<span class="nt">-DTEST_SUITE_PASSES_ARGS</span><span class="o">=</span> <span class="se">\</span>
<span class="s2">"-DTEST_SUITE_SUBDIRS=SingleSource;MultiSource"</span> <span class="se">\</span>
<span class="nt">-C</span> ../cmake/caches/O1.cmake ..
</pre></table></code></div></div><h3 id="how-to-skip-failed-targets"><span class="mr-2">How to Skip Failed Targets</span><a href="#how-to-skip-failed-targets" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>When building the CMake project, there may have some build targets that fail the compilation process at some step. Skipping these targets in the build process is interesting when you want to know what is the maximum number of targets you can build with your pass.</p><p>To do that, first you need to know which build system you’re using. When using <strong>ninja-build</strong>, you can specify the <em>-k</em> option to skip all failed tests [4]. Once you know the correct CLI options that enables you to keep building the CMake project, you can append them into the build command using the <code class="language-plaintext highlighter-rouge">--</code> chars:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>cmake <span class="nt">--build</span> <span class="nb">.</span> <span class="nt">--</span> <span class="nt">-k</span> 0
</pre></table></code></div></div><h3 id="running-and-comparing-experiments-automatically"><span class="mr-2">Running and Comparing Experiments Automatically</span><a href="#running-and-comparing-experiments-automatically" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>I had three passes to test and collect code size metrics. These are <a href="https://github.com/rcorcs/llvm-project/commit/246386f55764c35901099ca03b6fda4e20d36354#diff-883188285e4fa4d291d33f72aec6ac43acb685f6844c4a9c4e34ae2523268ed4" target="_blank">func-merging</a>, <a href="https://github.com/rcorcs/llvm-project/commit/246386f55764c35901099ca03b6fda4e20d36354#diff-e45e1412a61406b2aaaa1b2daf065500b8e95f6c08aec97a64f80b8351652640" target="_blank">loop-rolling</a> and <a href="https://github.com/rcorcs/llvm-project/commit/246386f55764c35901099ca03b6fda4e20d36354#diff-f72b25ed9b88723fe206a157fc8b7441447c8747c754c13bf605ba7347768389" target="_blank">brfusion</a>. Basically, if I want to collect those metrics, I just rebuild the test suite over and over. But there may have some build targets that failed, tests that don’t pass when they are compiled with different passes or tests that don’t terminate under LIT.</p><p>To tackle these problems, my current approach is to ignore all files that are associated with failed tests and run the experiments in a chosen order.</p><p>Building the test suite with my passes before the baseline guarantees that my comparison of results are computed correctly, given the same set of <code class="language-plaintext highlighter-rouge">.test</code> files.</p><p>To prevent LIT from entering an infinite loop, I’ve used the <code class="language-plaintext highlighter-rouge">--timeout</code> CLI option to set a maximum time of execution of 120 seconds.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$ </span>llvm-lit <span class="nt">-s</span> <span class="nt">--timeout</span> 120 <span class="nt">-v</span> <span class="nt">-o</span> ~/lit-results/results_baseline.json <span class="nb">.</span>
</pre></table></code></div></div><p><strong>Note</strong>: to use this feature, you need to install the <code class="language-plaintext highlighter-rouge">psutil</code> python package.</p><p>Here is the PoC of my approach: <a href="https://is.gd/Ezd8nv" target="_blank">https://is.gd/Ezd8nv</a>.</p><hr /><h2 id="errata"><span class="mr-2">Errata</span><a href="#errata" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>It was assumed in the CMake commands that the tests should not be really run by LIT, but instead they were being used to collect only code size metrics, compromising the correctness of each test. Hence, to fix that, I’ve removed the following CMake variable from the commands:</p><blockquote><p>-DTEST_SUITE_RUN_BENCHMARKS=OFF</p></blockquote><hr /><h2 id="references"><span class="mr-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>[1] <a href="https://discourse.llvm.org/t/how-to-use-llvm-test-suite-to-experiment-with-alias-analysis/69668/10" target="_blank">https://discourse.llvm.org/t/how-to-use-llvm-test-suite-to-experiment-with-alias-analysis/69668/10</a></p><p>[2] <a href="https://releases.llvm.org/17.0.1/docs/TestSuiteGuide.html" target="_blank">https://releases.llvm.org/17.0.1/docs/TestSuiteGuide.html</a></p><p>[3] <a href="https://releases.llvm.org/17.0.1/docs/CommandGuide/lit.html" target="_blank">https://releases.llvm.org/17.0.1/docs/CommandGuide/lit.html</a></p><p>[4] <a href="https://manpages.debian.org/bullseye/ninja-build/ninja.1.en.html" target="_blank">https://manpages.debian.org/bullseye/ninja-build/ninja.1.en.html</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/compilers/'>Compilers</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/compilers/" class="post-tag no-text-decoration" >compilers</a> <a href="/tags/open-source/" class="post-tag no-text-decoration" >open-source</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=How%20to%20build%20the%20LLVM%20Test%20Suite%20with%20an%20arbitrary%20pass?%20-%20Casperento&url=https%3A%2F%2Fcasperento.github.io%2Fposts%2Fhow-to-build-llvm-test-suite-with-an-arbitrary-pass%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=How%20to%20build%20the%20LLVM%20Test%20Suite%20with%20an%20arbitrary%20pass?%20-%20Casperento&u=https%3A%2F%2Fcasperento.github.io%2Fposts%2Fhow-to-build-llvm-test-suite-with-an-arbitrary-pass%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fcasperento.github.io%2Fposts%2Fhow-to-build-llvm-test-suite-with-an-arbitrary-pass%2F&text=How%20to%20build%20the%20LLVM%20Test%20Suite%20with%20an%20arbitrary%20pass?%20-%20Casperento" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/how-to-build-llvm-test-suite-with-an-arbitrary-pass/">How to build the LLVM Test Suite with an arbitrary pass?</a><li><a href="/posts/Welcome-To-My-Blog!/">Welcome to my blog!</a><li><a href="/posts/how-to-split-strings-using-regex/">How to split strings using regex?</a><li><a href="/posts/downloading-videos-with-multi-threaded-youtube-dl/">Downloading videos with multi-threaded youtube-dl</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/compilers/">compilers</a> <a class="post-tag" href="/tags/open-source/">open-source</a> <a class="post-tag" href="/tags/about/">about</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/regex/">regex</a> <a class="post-tag" href="/tags/utils/">utils</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/what-s-behind-the-so-called-code-prettifier-tools/"><div class="card-body"> <em class="small" data-ts="1677110400" data-df="ll" > Feb 22, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>What's behind the so called 'code prettifier' tools?</h3><div class="text-muted small"><p> If you’ve ever wondered the same question as the title, the short answer is: a compiler. Note: I have limited knowledge on code prettifier tools and their implementations. Now, let’s proceed with...</p></div></div></a></div><div class="card"> <a href="/posts/how-to-split-strings-using-regex/"><div class="card-body"> <em class="small" data-ts="1663111800" data-df="ll" > Sep 13, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to split strings using regex?</h3><div class="text-muted small"><p> Problem Statement What if I ask you to split a paragraph in phrases delimited by .?! ? What would be your first approach ? Also, I want you to include the phrase itself and it’s delimiters (.?!)...</p></div></div></a></div><div class="card"> <a href="/posts/downloading-videos-with-multi-threaded-youtube-dl/"><div class="card-body"> <em class="small" data-ts="1659206820" data-df="ll" > Jul 30, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Downloading videos with multi-threaded youtube-dl</h3><div class="text-muted small"><p> Today I’d like to share a trick I’ve learned to download videos faster using youtube-dl. The youtube-dl tool is a command-line utility to download videos from YouTube. But sometimes, when you try t...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/what-s-behind-the-so-called-code-prettifier-tools/" class="btn btn-outline-primary" prompt="Older"><p>What's behind the so called 'code prettifier' tools?</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/compilers/">compilers</a> <a class="post-tag" href="/tags/open-source/">open-source</a> <a class="post-tag" href="/tags/about/">about</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/regex/">regex</a> <a class="post-tag" href="/tags/utils/">utils</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/Casperento">Rafael Eckstein</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
